============================================
CAMBIOS EN RESERVA DE CABAÑAS
WebPay y Códigos de Descuento
============================================

PROBLEMAS SOLUCIONADOS:
=======================

1. ✅ WEBPAY: Reserva no se crea hasta confirmar pago
2. ✅ DESCUENTOS: Los códigos de descuento ahora cambian el precio total correctamente

============================================
PROBLEMA 1: WEBPAY - Reservas quedan tomadas aunque el usuario no pague
============================================

ANTES:
------
- El frontend creaba la reserva ANTES de ir a WebPay
- Si el usuario cancelaba el pago en WebPay, la reserva quedaba "pendiente" ocupando la cabaña
- Esto bloqueaba fechas innecesariamente

DESPUÉS:
--------
- El frontend NO crea la reserva inmediatamente
- Se envían los datos de la reserva a WebPay junto con la transacción
- El backend guarda estos datos en el campo "reserva_data_json" de la tabla transacciones_webpay
- SOLO cuando WebPay confirma el pago (response_code = 0), el backend crea la reserva automáticamente
- Si el usuario cancela, NO se crea ninguna reserva y la cabaña queda disponible

ARCHIVOS MODIFICADOS:
---------------------

1. backend/controllers/webpayController.js
   - Línea 15: Añadido parámetro "reserva_data" en crearTransaccion()
   - Línea 37-53: Permitir crear transacción sin reserva_id (se usa timestamp temporal)
   - Línea 87: Guardar reserva_data_json en la tabla
   - Línea 160-256: En confirmarTransaccion(), crear la reserva desde reserva_data_json cuando se aprueba el pago
   - Línea 167-213: Insertar reserva en BD
   - Línea 215-229: Insertar tinajas asociadas
   - Línea 231-245: Insertar matrículas asociadas
   - Línea 247-255: Actualizar transacción con el reserva_id generado

2. frontend/src/pages/ReservaCabanasPage.jsx
   - Línea 1721-1727: Eliminada la creación de reserva antes de WebPay
   - Ahora se envía "reserva_data" directamente a /webpay/crear

3. backend/scripts/agregar_columna_reserva_data_json.sql (NUEVO)
   - Script SQL para agregar la columna "reserva_data_json" a transacciones_webpay

============================================
PROBLEMA 2: CÓDIGOS DE DESCUENTO - No cambiaban el precio total
============================================

ANTES:
------
- calcularPrecioTotal() siempre devolvía el precio SIN descuento
- calcularMontoAPagar() no aplicaba descuentos
- El descuento se calculaba pero no se aplicaba al precio mostrado

DESPUÉS:
--------
- calcularPrecioTotal() sigue devolviendo el SUBTOTAL sin descuento
- Agregada nueva función calcularTotalConDescuento() que aplica el descuento
- Modificada calcularMontoAPagar() para usar calcularTotalConDescuento()
- El precio mostrado ahora refleja correctamente el descuento aplicado

ARCHIVOS MODIFICADOS:
---------------------

1. frontend/src/pages/ReservaCabanasPage.jsx
   - Línea 1288-1302: Renombrada y comentada calcularPrecioTotal() como "Subtotal SIN descuento"
   - Línea 1304-1309: Nueva función calcularTotalConDescuento() que aplica descuentos
   - Línea 1311-1315: Modificada calcularMontoAPagar() para usar calcularTotalConDescuento()

2. Display de precios (ya estaba bien implementado):
   - Línea 2465-2468: Calcula subtotal, descuento y total correctamente
   - Línea 2616-2623: Muestra el descuento aplicado en verde
   - Línea 2627-2636: Muestra el total con descuento y el precio anterior tachado
   - Línea 2655: Muestra el total con descuento en "Pago Completo"
   - Línea 2672: Muestra la mitad del total con descuento en "Pago Mitad"

============================================
INSTRUCCIONES DE INSTALACIÓN:
============================================

PASO 1: AGREGAR COLUMNA A LA BASE DE DATOS
-------------------------------------------
1. Abrir SQL Server Management Studio (SSMS)
2. Conectarse a la base de datos "gestionbeach"
3. Abrir: backend/scripts/agregar_columna_reserva_data_json.sql
4. Ejecutar el script (F5)
5. Verificar que aparezca el mensaje: "✅ Columna reserva_data_json agregada exitosamente"

PASO 2: REINICIAR BACKEND
--------------------------
1. Si el backend está corriendo, detenerlo (Ctrl+C)
2. Reiniciar: node server.js
3. Verificar que no haya errores

PASO 3: REINICIAR FRONTEND (si está corriendo)
----------------------------------------------
1. No es necesario hacer cambios, pero si hay problemas:
2. Ctrl+C para detener
3. npm start para reiniciar

PASO 4: PROBAR EL SISTEMA
--------------------------

A) Probar WebPay:
   1. Ir a /reserva-cabanas
   2. Seleccionar una cabaña y fechas
   3. Llenar el formulario
   4. Seleccionar "Pago con Webpay"
   5. IMPORTANTE: Cancelar el pago en WebPay (salir sin pagar)
   6. Verificar que NO se creó ninguna reserva en la BD
   7. Verificar que las fechas siguen disponibles
   8. Repetir pero esta vez completar el pago
   9. Verificar que la reserva se crea SOLO después de pagar

B) Probar Códigos de Descuento:
   1. Ir a /reserva-cabanas
   2. Seleccionar una cabaña y fechas
   3. Anotar el precio total mostrado
   4. En el paso de "Resumen y Pago", ingresar un código de descuento válido
   5. Hacer clic en "Aplicar"
   6. Verificar que:
      - Aparece un mensaje "✓ Código aplicado: [descripción]"
      - Se muestra el descuento en verde
      - El TOTAL cambia al precio con descuento aplicado
      - El precio anterior se muestra tachado
      - El monto a pagar (completo o mitad) refleja el descuento

============================================
CAMBIOS EN LA BASE DE DATOS:
============================================

Tabla: transacciones_webpay
Nueva columna:
  - reserva_data_json (NVARCHAR(MAX), NULL)
    Almacena los datos de la reserva en formato JSON
    Solo se usa cuando NO hay reserva_id al momento de crear la transacción

============================================
FLUJO COMPLETO DE WEBPAY (NUEVO):
============================================

1. Usuario selecciona cabaña y completa formulario
2. Usuario elige "Pago con Webpay"
3. Frontend:
   - Prepara los datos de la reserva (reservaData)
   - Calcula el monto total con descuentos
   - Envía a /webpay/crear con "reserva_data" y "monto"
4. Backend (webpayController.crearTransaccion):
   - Crea transacción en Webpay
   - Guarda token en BD junto con reserva_data_json
   - NO crea la reserva todavía
5. Usuario es redirigido a WebPay
6. ESCENARIO A: Usuario cancela
   - WebPay no llama al callback
   - No se crea ninguna reserva
   - Transacción queda como "INICIADO" en BD
   - Fechas quedan disponibles
7. ESCENARIO B: Usuario paga exitosamente
   - WebPay llama al callback con token
   - Backend (webpayController.confirmarTransaccion):
     * Confirma la transacción con Webpay
     * Lee reserva_data_json de la transacción
     * CREA LA RESERVA con estado "confirmada" y estado_pago según corresponda
     * Inserta tinajas asociadas
     * Inserta matrículas asociadas
     * Actualiza transacción con el reserva_id
     * Actualiza monto_pagado y estado_pago de la reserva
   - Usuario es redirigido al frontend con pago=exitoso

============================================
FLUJO DE CÓDIGOS DE DESCUENTO:
============================================

1. Usuario ingresa código en el campo "¿Tienes un código promocional?"
2. Hace clic en "Aplicar"
3. Frontend llama a /codigos-descuento/validar
4. Backend verifica:
   - Código existe
   - Está activo
   - No ha expirado
   - Tiene usos disponibles
5. Si es válido:
   - Frontend guarda el código validado
   - Calcula el descuento (porcentaje o monto fijo)
   - Muestra el descuento aplicado
   - Actualiza el precio total
6. Al procesar el pago:
   - Se envía el código_descuento en reserva_data
   - Se incrementa el contador de usos
   - Se guarda el descuento en la reserva

============================================
NOTAS IMPORTANTES:
============================================

1. Las transacciones que quedan como "INICIADO" y sin reserva_id son normales
   (son pagos que el usuario canceló o no completó)

2. Solo las transacciones "APROBADO" tendrán reserva_id asociado

3. El campo reserva_data_json solo se llena cuando se crea la transacción sin reserva previa
   Una vez creada la reserva, este campo ya no se usa

4. Los códigos de descuento se validan ANTES de procesar el pago
   Si el usuario cierra WebPay, el código NO incrementa su uso
   Solo se incrementa al confirmar el pago

5. La columna "descuento" en reservas_cabanas almacena el monto descontado
   La columna "codigo_descuento" almacena el código usado (si aplica)

============================================
FIN DEL DOCUMENTO
============================================
